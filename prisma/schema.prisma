// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// VideoBlade Enums
enum Platform {
    YOUTUBE
    RUMBLE
    TIKTOK
}

enum PublishStatus {
    PENDING
    SCHEDULED
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
}

enum VideoPrivacy {
    PUBLIC
    UNLISTED
    PRIVATE
    MUTUAL_FOLLOW_FRIENDS
}

model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    createdBy   User   @relation(fields: [createdById], references: [id])
    createdById String

    @@index([name])
}

// Better Auth schema - clean implementation
model Account {
    id                String   @id @default(cuid())
    userId            String
    accountId         String
    providerId        String
    accessToken       String?
    refreshToken      String?
    idToken           String?
    accessTokenExpiresAt DateTime?
    refreshTokenExpiresAt DateTime?
    scope             String?
    password          String?
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@unique([providerId, accountId])
}

model Session {
    id        String   @id @default(cuid())
    token     String   @unique
    userId    String
    expiresAt DateTime
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified Boolean?
    image         String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    accounts      Account[]
    sessions      Session[]
    posts         Post[]

    // VideoBlade relations
    videos             Video[]
    platformConnections PlatformConnection[]
    publishJobs        PublishJob[]
}

model Verification {
    id         String   @id @default(cuid())
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([identifier, value])
}

// VideoBlade Models
model Video {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // S3 Storage
    s3Key       String
    s3Bucket    String
    fileName    String
    fileSize    BigInt
    mimeType    String
    duration    Int?

    // Metadata
    title        String
    description  String?
    tags         String?
    thumbnailUrl String?
    privacy      VideoPrivacy @default(UNLISTED)

    // Relationships
    createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
    createdById String

    publishJobs PublishJob[]

    @@index([createdById])
    @@index([createdAt])
}

model PlatformConnection {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Platform info
    platform         Platform
    platformUserId   String
    platformUsername String?

    // OAuth tokens
    accessToken  String
    refreshToken String?
    tokenExpiry  DateTime?

    // Platform-specific data (JSON)
    metadata Json?

    // Status
    isActive Boolean @default(true)

    // Relationships
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    publishJobs PublishJob[]

    // One connection per platform per user
    @@unique([userId, platform])
    @@index([userId])
    @@index([platform])
}

model PublishJob {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Job details
    platform Platform
    status   PublishStatus @default(PENDING)

    // Platform-specific metadata (overrides from Video)
    title       String?
    description String?
    tags        String?
    privacy     VideoPrivacy?

    // Scheduling
    scheduledFor DateTime?
    startedAt    DateTime?
    completedAt  DateTime?

    // Result
    platformVideoId  String?
    platformVideoUrl String?
    errorMessage     String?
    retryCount       Int     @default(0)

    // Update logic (for editing already-published videos)
    isUpdate           Boolean @default(false)
    updateTargetVideoId String?

    // Relationships
    video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
    videoId String

    platformConnection   PlatformConnection @relation(fields: [platformConnectionId], references: [id], onDelete: Cascade)
    platformConnectionId String

    createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
    createdById String

    @@index([videoId])
    @@index([platformConnectionId])
    @@index([createdById])
    @@index([status])
    @@index([scheduledFor])
}
